<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Admin Portal | Jobs</title>

    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/bootstrap-switch.css">
    <link rel="stylesheet" href="/css/backend/backend.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <style>
      .fa-trash-alt, .fa-plus-square, .fa-external-link, .dropzone {
        cursor: pointer;
      }

      #manager .fa-plus-square, #manager .right-corner {
        display: none;
      }

      .fa-trash-alt {
        background: #CA2525;
        border-radius: 3px;
        color: #F3D2D2;
        font-size: 12pt;
        padding: 3px 6px;
      }

      .fa-plus-square {
        color: #428bca;
      }

      .fa-plus-square:hover {
        color: #3276b1;
      }

      .fa-external-link {
        color: #428bca;
        padding-left: 25px;
      }

      .fa-external-link:hover {
        color: #3276b1;
      }

      .fa-trash-alt:hover {
        background: #9D1515;
      }

      .right-corner {
        position: absolute;
        top: 15px;
        right: 15px;
      }

      .fa-trash-alt.large {
        padding: 5px 8px;
        font-size: 16pt;
        float: right;
      }

      .edit {
        -webkit-transition: border-color 1s; /* Safari */
        transition: border-color 1s;
        border: 1px solid #FFF;
      }

      .edit-border {
        border-color: #428bca !important;
      }

      hr.middle-fade {
        border: 0;
        height: 1px;
        background: #999;
        background-image: linear-gradient(to right, #ccc, #999, #ccc);
      }

      #dropzone {
        position: relative;
        height: 27vw;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      #dropzone .dz-preview {
        visibility: hidden;
        display: none;
      }

      #dropzone .dz-message {
        font-size: 4vw;
        padding-top: 15vw;
        text-align: center;

        background-color: #AAA;
        opacity: 0.6;
        color: transparent;
        text-shadow: 0px 2px 3px rgba(255,255,255,0.5);
        -webkit-background-clip: text;
            -moz-background-clip: text;
                 background-clip: text;

       -webkit-transition: background-color 0.6s; /* Safari */
       transition: background-color 0.6s;
      }

      #dropzone.dz-drag-hover .dz-message {
        background-color: #777 !important;
      }

      .dropzone img {
        -webkit-transition: filter 0.6s; /* Safari */
        transition: filter 0.6s;
      }

      .dropzone.dz-drag-hover img {
        filter: brightness(65%);
      }

      .dropzone:hover img {
        filter: brightness(65%);
      }

      .dropzone .dz-preview {
        visibility: hidden;
        display: none;
      }

      #dropzone::before {
        padding-top: 2vw;
        margin: auto;
        text-align: center;
        font-size: 9vw;
        position: absolute;
        z-index: 10;
        top: 15px;
        left: 15px;
        right: 15px;
        bottom: 15px;
        border-radius: 4px;
        border: 8px dashed #CCC;
        content: " ";
        opacity: 0.6;
        -webkit-transition: background-color 0.6s, border-color 0.6s; /* Safari */
        transition: background-color 0.6s, border-color 0.6s;
      }

      #dropzone.dz-drag-hover::before {
        border-color: #AAA !important;
      }

      #dropzone .icon {
        font-size: 10vw;
        padding-top: 2vw;
        text-align: center;
        position: absolute;
        z-index: 10;
        top: 15px;
        left: 15px;
        right: 15px;
        bottom: 15px;
      }

      #dropzone .icon i {
        background-color: #AAA;
        opacity: 0.6;
        color: transparent;
        text-shadow: 0px 2px 3px rgba(255,255,255,0.5);
        -webkit-background-clip: text;
        -moz-background-clip: text;
        background-clip: text;

        -webkit-transition: display 1s, background-color 0.6s; /* Safari */
        transition: display 1s, background-color 0.6s;
      }

      #dropzone.dz-drag-hover .icon i {
        background-color: #777 !important;
      }

      #dropzone #disabled {
        font-size: 7vw !important;
        padding-top: 1.5vw !important;
      }

      #dropzone #disabled i, #dropzone #loader i {
        display: none;
      }

      #dropzone.dropped #ready i {
        display: none !important;
      }

      .jumbotron {
        position: relative;
        width: 75%;
        margin: 15px auto;
        padding-bottom: 90px;
        border-radius: 4px;
      }

      .dropdown {
        font-size: 14pt;
        float: right;
        margin-right: 10px;
      }

      .dropdown-list h3 {
        font-size: 21px;
        width: 275px;
        cursor: pointer;
        margin-right: 10px;
        padding: 3px 0px 3px 7px;
        border: 1px solid #CCC;
        border-radius: 4px;
        display: block;
        margin: 0;
      }

      .dropdown .dropdown-list {
        position: relative;
        padding: 0px;
        width: 88%;
        background: white;
        list-style: none;
      }

      .dropdown .dropdown-list li {
        position: relative;
        background: white;
        z-index: 15;
        display: none;
        border-left: 1px solid #CCC;
        border-right: 1px solid #CCC;
        padding: 3px 0px 3px 7px;
        cursor: pointer;
        overflow: hidden;
        margin: 0;
        width: 244px;
      }

      .dropdown .dropdown-list li:hover {
        background: #428bca;
        color: white;
      }

      .dropdown .dropdown-list li:first-child {
        border-top: 1px solid #CCC;
      }

      .dropdown .dropdown-list li:last-child {
        border-bottom: 1px solid #CCC;
        border-radius: 0px 0px 4px 4px;
      }

      .fa-chevron-down {
        position: relative;
        top: -4px;
        float: right;
        padding: 5px;
        border-radius: 0px 4px 4px 0px;
        background: #428bca;
        color: white;
      }

      .dropdown-list h3:hover .fa-chevron-down {
        background: #3276b1;
      }

      .open {
        border-bottom-left-radius: 0px !important;
      }

      .link {
        cursor: pointer;
        -webkit-user-select: none; /* Chrome/Safari */
        -moz-user-select: none; /* Firefox */
        -ms-user-select: none; /* IE10+ */

        /* Rules below not implemented in browsers yet */
        -o-user-select: none;
        user-select: none;
      }

      .link.active {
        background: #428bca !important;
        color: white !important;
      }

      .link.active .fa-external-link {
        color: white !important;
      }

      .delete {
        color: white;
        background: #CA2525;
        float: right;
      }

      .delete:hover {
        color: white;
        background: #9D1515;
      }

      .image-wrapper {
        position: relative;
        display: inline-block;
      }

      .image-wrapper:hover i {
        opacity: 1.0 !important;
      }

      .image-wrapper i {
        position: absolute;
        font-size: 24pt;
        bottom: 10px;
        right: 10px;
        color: #bbb;
        background-color: white;
        padding: 3px 7px;
        border-radius: 5px;
        opacity: 0.0;
        cursor: pointer;

        -webkit-transition: opacity 0.6s; /* Safari */
        transition: opacity 0.6s;
      }

      a.btn {
        float: right;
        margin-left: 20px;
      }

      #controls {
        display: none;
      }
    </style>

    <script src="/js/jquery-2.2.3.min.js"></script>
    <script src="/js/bootstrap-switch.js"></script>
    <script type="text/javascript" src="//static.filestackapi.com/v3/filestack.js"></script>
  </head>
  <body>
    <%- include ../../partials/backend-nav.ejs %>
    <div id='manager' class='manager'>
      <span style='position: absolute; top: 40px; right: 30px;'>
        <input id='edit-switch' type="checkbox" data-on-text='View' data-off-text='Edit' data-on-color='default' data-off-color='primary' checked>
      </span>

      <h1 class="display-4">Jobs Manager</h1>

      <p class="lead">To edit the jobs, toggle the switch to edit then save your changes.</p>

      <h2>Jobs&nbsp;<i class="fa fa-plus-square" aria-hidden="true" data-type='jobs'></i></h2>
      <div id='jobs-list' class="list-group">
        <!-- Filled by EJS dump to job_save and then method revert called once document.ready() -->
      </div>

      <div id='controls'>
        <button id='revert' type="button" class="btn btn-info">Revert Changes</button>
        <button id='save' type="button" class="btn btn-primary">Save Changes</button>
      </div>
    </div>

    <script src="//cdnjs.cloudflare.com/ajax/libs/dropzone/5.1.1/min/dropzone.min.js"></script>
    <script>
      var job_save = [
        <% for(var i=0; i<jobs.length; i++) {%>
          {
            "id": <%= jobs[i].id %>,
            "title": "<%= jobs[i].title %>",
            "img": "<%= jobs[i].img %>",
            "description": "<%= jobs[i].description %>"
          },
        <% } %>
      ];
      var job_dels = [];
      var n = 0;
      var jid;

      Dropzone.autoDiscover = false;
      // Dropzone.clickable = true;
      //
      // // Initialise DropZone form control
      // Dropzone.options.dropzone = {
      //   init: function () {
      //     // Set up any event handlers
      //     this.on('success', function(file, response) {
      //       console.log(id);
      //       updateImage(id, file.name);
      //     });
      //   }
      // };

      $(document).ready(function() {
        revert(false);

        $("#edit-switch").bootstrapSwitch();

        $('#edit-switch').on('switchChange.bootstrapSwitch', function(event, state) {
          toggleEdit(state);
        });

        $('#save').on('click', function() {
          $('#save').prop('disabled', true);

          save();

          $('#save').prop('disabled', false);
          $("#edit-switch").bootstrapSwitch('state', true);
        });

        $('#revert').on('click', function() {
          revert(true);
        });

        // $(':file').on('fileselect', function(event, numFiles, label) {
        //   var input = $(this).parents('.input-group').find(':text');
        //   var log = numFiles > 1 ? numFiles + ' files selected' : label;
        //
        //   if(input.length) {
        //     // uploading();
        //     input.val(log);
        //
        //     var form = new FormData($(this).closest('form')[0]);
        //     $.ajax({
        //       url: "/admin/manage/jobs",
        //       method: "POST",
        //       dataType: "json",
        //       data: form,
        //       processData: false,
        //       contentType: false,
        //       success: function(result){
        //         console.log(result);
        //       },
        //       error: function(err){
        //         console.log(err);
        //       }
        //     });
        //   }
        // });
      });

      function save() {
        job_save = getJobs();

        $.each(job_save, function(i, val) {
          if(val.id.includes("new")) {
            $.post("/admin/manage/jobs/insert", {"job": val}, function(result) {
              $("[data-job-id='" + val.id + "']").attr("data-job-id", result.id);
              console.log(result);
            });
          } else {
            $.post("/admin/manage/jobs/update", {"job": val}, function(result) {
              console.log(result);
            });
          }
        });

        if(job_dels.length > 0) {
          $.post("/admin/manage/jobs/delete", {"jobs": job_dels}, function(result) {
            console.log(result);
          });
        }

        $.post("/admin/manage/jobs/clean", function(result) {
          console.log(result);
        });
      }

      function getJobs() {
        var jobs = [];
        $('[data-id="job"]').each(function() {
          var id = $(this).attr('data-job-id');
          var title = $.trim($(this).find('[data-id="title"]').html());
          var img = $(this).find('[data-id="img"]').attr('data-img');
          var description = $.trim($(this).find('[data-id="description"]').html());

          var job = {
            'id':          id,
            'title':       title,
            'img':         img,
            'description': description,
          };
          jobs.push(job);
        });

        return jobs;
      }

      function newJob(id, title, img, description) {
        alt = title;
        src = "<%= url %>" + img;
        if(img == "") {
          img = "/img/noimage.png";
          src = img;
          alt = "No Image";
        }

        $('#jobs-list').append(
          '<li class="list-group-item list-group-item-action flex-row align-items-start" data-id="job" data-job-id=' + id + '>'
            + '<span class="right-corner">'
              + '<i class="far fa-trash-alt large file" aria-hidden="true"></i>'
            + '</span>'
            + '<div class="image-wrapper">'
            + '<form id="dropzone-' + id + '" class="dropzone" method="post" action="/admin/manage/jobs" data-job-id=' + id + '>'
              + '<img data-id="img" data-img="'+ img + '" style="width: 200px" src="' + src + '" alt="' + alt + '">'
              + '<i class="fa fa-upload" aria-hidden="true"></i>'
              + '<div class="dz-message" data-dz-message></div>'
              + '<div class="fallback">'
                + '<input type="file" name="upload" multiple hidden>'
              + '</div>'
              + '<input type="text" name="id" value=' + id + ' hidden>'
            + '</form>'
            + '</div>'
            + '<div style="display:inline-block; padding-left: 20px">'
              + '<div class="d-flex justify-content-between">'
                + '<h3 class="mb-1">'
                  + '<span class="edit" data-id="title">' + title + '</span>'
                + '</h3>'
              + '</div>'
              + '<p class="mb-1" style="padding-left:18px;">'
                + '<span class="edit" data-id="description">' + description + '</span>'
              + '</p>'
            + '</div>'
          + '</li>'
        );

        var dz = $('#dropzone-' + id).dropzone({clickable: '#dropzone-' + id + ' *'})[0];
        dz.dropzone.on('complete', function (file, response) {
          updateImage(id, file.name);
        });
        dz.dropzone.on('addedfile', function (file) {
          loading('#dropzone-' + id);
        });

        $('#dropzone-' + id).on('drop', function() {
          loading(this);
          // jid = $(this).attr('data-job-id');
        });
        $('#dropzone-' + id).on('click', function() {
          // jid = $(this).attr('data-job-id');
        });
      }

      function toggleEdit(state) {
        if(!state) {
          setClicks();
          $('.edit').attr('contenteditable', true);
          $('.edit').addClass('edit-border');
          $('.right-corner').attr('contenteditable', false);
          $('.fa-plus-square').attr('contenteditable', false);
          $('#controls').fadeIn();
          $('.fa-plus-square').fadeIn();
          $('#manager .right-corner').fadeIn();
        } else {
          revert(false);
          $('.edit').attr('contenteditable', false);
          $('.edit').removeClass('edit-border');
          $('.right-corner').attr('contenteditable', false);
          $('#controls').fadeOut();
          $('.fa-plus-square').fadeOut();
          $('#manager .right-corner').fadeOut();
        }
      }

      function setClicks() {
        $('.fa-plus-square').off('click');
        $('.fa-plus-square').on('click', function() {
          newJob('new' + n, 'New Job', '', 'This is a new job.');
          n++;
          toggleEdit(false);
        });

        $('[data-id="title"]').off('keypress')
        $('[data-id="title"]').on('keypress', function(e) {
          var key = e.which;
          if(key == 13) {
            e.preventDefault();
            e.stopPropagation();
            $(this).closest('[data-id="job"]').append(
              newJob('new' + n, 'New Job', '', 'This is a new job.')
            );
            n++;
            toggleEdit(false);
          }
        });

        $('[data-id="description"]').off('keypress')
        $('[data-id="description"]').on('keypress', function(e) {
          var key = e.which;
          if(key == 13) {
            e.preventDefault();
            e.stopPropagation();
            $(this).closest('[data-id="job"]').append(
              newJob('new' + n, 'New Job', '', 'This is a new job.')
            );
            n++;
            toggleEdit(false);
          }
        });

        $('.fa-trash-alt').off('click');
        $('.fa-trash-alt').on('click', function() {
          var parent = $(this).closest('[data-id="job"]');
          var attr = parent.attr('data-job-id');

          if (typeof attr !== typeof undefined && attr !== false && !attr.includes("new")) {
            job_dels.push(attr);
          }
          parent.remove();
        });

        $('.upload-form').off('submit');
        $('.upload-form').on('submit', function(e) {
          e.preventDefault();
        });
      }

      function revert(toggle) {
        $('#jobs-list').html('');

        $.each(job_save, function(i, value) {
          newJob(value.id, value.title, value.img, value.description);
        });

        setClicks();
        if(toggle) {
          toggleEdit(false);
        }
      }

      function loading(dz) {
        $(dz).find('i').removeClass('fa-upload');
        $(dz).find('i').addClass('fa-circle-o-notch');
        $(dz).find('i').addClass('fa-spin');
        $(dz).find('i').css({'opacity': 1.0, 'background-color': 'transparent'});
      }

      function doneLoading(dz) {
        $(dz).find('i').removeClass('fa-circle-o-notch');
        $(dz).find('i').removeClass('fa-spin');
        $(dz).find('i').addClass('fa-upload');
        $(dz).find('i').css({'opacity': 0.0, 'background-color': 'white'});
      }

      var retries = 5;
      function updateImage(id, img) {
        $.ajax({
          type          : 'GET',
          url           : "<%= url %>" + img,
          success       : function (data) {
            retries = 3;
            console.log('success');
            console.log(id);
            $('#dropzone-' + id + ' img[data-id="img"]').attr('data-img', img);
            $('#dropzone-' + id + ' img[data-id="img"]').attr('src', '<%= url %>' + img);
            doneLoading('#dropzone-' + id);
          },
          error         : function(xhr, textStatus, errorThrown) {
            console.log("One fail.");
            if(retries > 0) {
              retries--;
              setTimeout(function() {
                updateImage(id, img);
              }, 5000);
            }
          }
        });
      }
    </script>
  </body>
</html>
