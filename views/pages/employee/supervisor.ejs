<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Employee Portal | Supervisor</title>

    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="//cdn.datatables.net/v/bs/jq-2.2.4/dt-1.10.15/r-2.1.1/datatables.min.css"/>
    <style>
      .fa-square-o {
        cursor: pointer;
      }
    </style>

    <script src="/js/jquery-2.2.3.min.js"></script>
    <script type="text/javascript" src="//cdn.datatables.net/v/bs/jq-2.2.4/dt-1.10.15/r-2.1.1/datatables.min.js"></script>
  </head>
  <body>
    <h1>Employee Portal | Supervisor</h1>

    <a href="/employee">Employee Home</a>
    <a href="/employee/accreditations">Accreditations</a>
    <a href="/employee/files">Files</a>
    <a href="/admin">Admin</a>
    <a href="/logout">Logout</a>

    <div id='accreditations'>
      <h3><%= accreditation.title %></h3>
      <ul>
      <% for(var j=0; j<accreditation.skills.length; j++) {%>
        <li><%= accreditation.skills[j] %></li>
      <% } %>
      </ul>
      <h4>Progress</h4>
      <ul>
      <% for(var j=0; j<steps.length; j++) {%>
        <li><%= steps[j].content %></li>
      <% } %>
      </ul>
    </div>

    <br>
    <table id="users-table" class="display">
      <thead>
        <tr>
          <th>Employee</th>
          <% for(var i = 0; i < steps.length; i++) { %>
            <th>Step <%= i + 1 %></th>
          <% } %>
        </tr>
      </thead>
    </table>

    <script>
      var steps = [
        <% for(var i = 0; i < steps.length; i++) { %>
          <%= steps[i].id %>,
        <% } %>
      ];

      $.fn.dataTableExt.afnFiltering.push(
        function(oSettings, aData, iDataIndex) {
          console.log(oSettings);
          console.log(aData);
          console.log(iDataIndex);
          var row = oSettings.aoData[iDataIndex].nTr;
          return !row.complete;
        }
      );

      function Employee(name, id, list) {
        this.name = name;
        this.id = id;
        // this.list = list;

        for(var i = 0; i < steps.length; i++) {
          if(list.indexOf(steps[i]) == -1) {
            this['step' + (i + 1)] = false;
          } else {
            this['step' + (i + 1)] = true;
          }
        }
      };

      $(document).ready(function() {
        $('#users-table').DataTable( {
          data: [
            <% for (var key in progress) { %>
              <% if(progress[key][accreditation.id] && progress[key][accreditation.id].length < steps.length) { %>
                new Employee("<%= progress[key].name %>", "<%= progress[key].id %>", [<%= progress[key][accreditation.id] %>]),
              <% } else if(!progress[key][accreditation.id]) { %>
                new Employee("<%= progress[key].name %>", "<%= progress[key].id %>", []),
              <% } %>
            <% } %>
          ],
          columns: [
            { data: 'name' },
            <% for(var i = 0; i < steps.length; i++) { %>
              {
                data: 'step<%= i + 1 %>',
                render: function (data, type, row) {
                  var c = "fa-square-o";
                  if(data) {
                    c = "fa-check-square-o";
                  }

                  return '<i class="fa ' + c + '" aria-hidden="true" data-step-id="<%= steps[i].id %>" data-user-id="' + row.id + '"></i>';
                }
              },
            <% } %>

          ]
        });

        $(".fa-square-o").on('click', function() {
          var icon = $(this);
          icon.removeClass('fa-square-o');
          icon.addClass('fa-circle-o-notch');
          icon.addClass('fa-spin');

          var step_id = icon.attr('data-step-id');
          var user_id = icon.attr('data-user-id');
          $.getJSON("/employee/accreditations/check?accred=<%= accreditation.id %>&step=" + step_id + "&user=" + user_id, function(result){
            if(result.success) {
              icon.removeClass('fa-circle-o-notch');
              icon.removeClass('fa-spin');
              icon.addClass('fa-check-square-o');
            }
          });
        });
      });
    </script>
  </body>
</html>
